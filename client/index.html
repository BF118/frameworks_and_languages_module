<!--https://scotch.io/courses/getting-started-with-vuejs/processing-a-form-with-vue-->
<!--https://redocly.github.io/redoc/?url=https://raw.githubusercontent.com/calaldees/frameworks_and_languages_module/main/openapi.yml#operation/addItem-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link id="favicon" rel="shortcut icon" type="image/png" href="data:image/png;base64,....==" />
    <title>Vue.js</title>
    <style>
html, body {
	font-family: Arial, Helvetica, sans-serif;
	margin: 0;
	padding: 0;
}
a {
	color: inherit;
	text-decoration: inherit;
}

#nav div {
	display: inline-block;
}

#nav h1 {
	margin: 0;
	padding: 0;
	display: inline-block;
}

#menu li {
	display: inline-block;
}

#user {
	float: right;
}

#main {

}

#templates {
	display: none;
}
    </style>
    <script src="https://unpkg.com/vue@next"></script>
</head>
<body>
    <div id="nav">
        <div id="logo">
            <a href="#">
                &#128205; <!-- Unicode for Map Pin - https://unicode-table.com/en/1F4CD/ -->
                <h1>FreeCycle</h1>
            </a>
        </div>
    </div>

<h3>New Item</h3>
<div id="main">
<form>
  <label for ="create_user_id">user_id</label>
  <input id ="create_user_id" type="text" name="user_id">
  <label for="create_lat">lat</label>
  <input id="create_lat" type="text" name="lat">
  <label for="create_lon">lon</label>
  <input id="create_lon" type="text" name="lon">
  <label id="create_keywords">keywords</label>
  <input for="create_keywords" type="text" name="keywords">
  <label for="create_description"> description</label>
  <input id="create_description"type="text" name="description">
  <label for="create_image">image</label><input id="create_image" type="text" name="image" value="http://placekitten.com/100/100"/>
  <input type="submit" id="action_create"data-action="create_item">
</form>
<h3>Items</h3>
<div data-page="items"><ul></ul></div>


<div id="templates">

<div data-page="item">
    
</div>

<div data-page="items">
    <h2>List items</h2>
    <ul>
        <li>
            <span data-field="id"></span>
            <img src="" data-field="image"/>
            <a href="" data-field="user_id"></a>
            LatLon: <span data-field="lat"></span>,<span data-field="lon"></span>
            <span data-field="date_from"></span>
            <p data-field="description"></p>
            <ul data-field="keywords"></ul>
            <button data-action="delete">delete</button>
        </li>
    </ul>
</div>
</div>
</body>


<script>
    
         const urlParams = new URLSearchParams(window.location.search);
	        const apiUrl = (urlParams.get('api') || '/api/v1').replace(/\/$/, '');
            url ="https://8000-sapphire-jaguar-8okm2lnn.ws-eu25.gitpod.io"
            
            const app = Vue.createApp({
                data() {
                    return {
                        items: null,
                        collapsed_div: true,
                        userId:'',
                        description:'',
                        image:'',
                        lat:'',
                        lon:'',
                        keywords_string:'',
                        title:''
                    }
                },
                mounted() {
                    this.load_items();
                },
                methods:{
                    load_items(){
                        fetch(url + "/items")
                            .then(function(res){
                                if(res.status == 204){
                                    return {};
                                }
                                else{
                                    return res.json();
                                }
                            })
                            .catch(err => console.log(err.message))
                    },

                    async create_item(){
                        var arr = this.keywords_string.split(',')
                        arr = arr.map(s => s.trim())
                        var data = {
                            user_id: this.userId,
                            description: this.description,
                            image: this.image,
                            lat: this.lat,
                            lon: this.lon,
                            keywords: arr,
                            title: this.title
                        }
                        console.log(data)
                       
                        var response = await fetch(url + "/item",{
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        }).catch(err => console.log(err))

                        //clear input fields
                        this.userId = '';
                        this.description = '';
                        this.image= '';
                        this.lat = '';
                        this.lon = '';
                        this.keywords_string = '';
                        this.title = '';

                      
                        for(let item of this.items){
                            this.hideMarker(item);
                        }

                        this.load_items()
                    },

                    async delete_item(item){
                        
                        await fetch(url + "/item/" + item.id, {
                            method: 'DELETE'
                        }).catch(err => console.log(err.message))
                        this.hideMarker(item);
                        this.load_items()
                    },

                    
                    onSubmit(event){
                        event.preventDefault(); 
                        var ele = document.getElementById("form");
                        var chk_status = ele.checkValidity();
                        ele.reportValidity();
                        if (chk_status){
                            this.create_item();
                        }
                    },

                    toggleCollapsed(){
                        this.collapsed_div = !this.collapsed_div;
                    }
                }
            });

            app.mount('#main')
        </script>

</body>
</html>