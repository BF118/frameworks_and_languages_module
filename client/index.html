<!--https://scotch.io/courses/getting-started-with-vuejs/processing-a-form-with-vue-->
<!--https://redocly.github.io/redoc/?url=https://raw.githubusercontent.com/calaldees/frameworks_and_languages_module/main/openapi.yml#operation/addItem-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link id="favicon" rel="shortcut icon" type="image/png" href="data:image/png;base64,....==" />
    <title>Vue.js</title>
    <style>
.grid {
  display: grid;
  grid-template-columns: 100px 400px;
  grid-gap: 10px;
}



    </style>
    <script src="https://unpkg.com/vue@next"></script>
</head>
<form>
  <label for ="create_user_id">user_id</label>
  <input id ="create_user_id" type="text" name="user_id">
  <label for="create_lat">lat</label>
  <input id="create_lat" type="text" name="lat">
  <label for="create_lon">lon</label>
  <input id="create_lon" type="text" name="lon">
  <label id="create_keywords">keywords</label>
  <input for="create_keywords" type="text" name="keywords">
  <label for="create_description"> description</label>
  <input id="create_description"type="text" name="description">
  <!--label for="image">image</label-->
  <!--input id="image" type="text" name="image" value="http://placekitten.com/100/100"-->
  <input type="submit" id="action_create"data-action="create_item">
</form>



<script>
         const urlParams = new URLSearchParams(window.location.search);
	        const apiUrl = (urlParams.get('api') || '/api/v1').replace(/\/$/, '');
            url ="https://8001-sapphire-jaguar-8okm2lnn.ws-eu25.gitpod.io"
            
            const app = Vue.createApp({
                data() {
                    return {
                        items: null,
                        collapsed_div: true,
                        userId:'',
                        description:'',
                        lat:'',
                        lon:'',
                        keywords_string:'',
                        title:''
                    }
                },
                mounted() {
                    this.load_items();
                },
                methods:{
                    load_items(){
                        fetch(Url + "/items")
                            .then(function(res){
                                if(res.status == 204){
                                    return {};
                                }
                                else{
                                    return res.json();
                                }
                            })
                            .then((data) => {
                                this.items = data;

                                for(var item of this.items){
                                    var markerTitle = '';
                                    if(item.title == '' || !item.hasOwnProperty('title')){
                                        markerTitle = "Item " + item.id;
                                    }
                                    else{
                                        markerTitle = item.title;
                                    }
                                    const marker = new google.maps.Marker({
                                        position: { lat: item.lat, lng: item.lon },
                                        map: map,
                                        visible: false,
                                        title: markerTitle
                                    });
                                    item.marker_visible = false;
                                    item.map_marker = marker;
                                }
                            })
                            .catch(err => console.log(err.message))
                    },

                    async create_item(){
                        var arr = this.keywords_string.split(',')
                        arr = arr.map(s => s.trim())
                        var data = {
                            user_id: this.userId,
                            description: this.description,
                            lat: this.lat,
                            lon: this.lon,
                            keywords: arr,
                            title: this.title
                        }

                        console.log(data)
                       
                        var response = await fetch(Url + "/item",{
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        }).catch(err => console.log(err))

                        //clear input fields
                        this.userId = '';
                        this.description = '';
                        this.lat = '';
                        this.lon = '';
                        this.keywords_string = '';
                        this.title = '';

                      
                        for(let item of this.items){
                            this.hideMarker(item);
                        }

                        this.load_items()
                    },

                    async delete_item(item){
                        
                        await fetch(Url + "/item/" + item.id, {
                            method: 'DELETE'
                        }).catch(err => console.log(err.message))
                        this.hideMarker(item);
                        this.load_items()
                    },

                    
                    onSubmit(event){
                        event.preventDefault(); 
                        var ele = document.getElementById("form");
                        var chk_status = ele.checkValidity();
                        ele.reportValidity();
                        if (chk_status){
                            this.create_item();
                        }
                    },

                    toggleCollapsed(){
                        this.collapsed_div = !this.collapsed_div;
                    }
                }
            });
            app.mount('#main')
        </script>

</body>
</html>